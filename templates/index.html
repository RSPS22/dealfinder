<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Deal Finder App</title>
    <style>
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
        th.sortable:hover { cursor: pointer; background-color: #f0f0f0; }
        .btn { padding: 6px 12px; margin: 4px; }
        .highlight { background-color: #c8f7c5; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; }
        .input-group { margin-bottom: 10px; }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>âœ… Deal Finder App</h1>
        <a href="/dashboard"><button class="btn">Go to Dashboard</button></a>
    </div>

    <div class="input-group">
        <label>Business Name: <input type="text" id="businessName"></label>
        <label>Your Name: <input type="text" id="userName"></label>
        <label>Your Email: <input type="email" id="userEmail"></label>
    </div>

    <label>ðŸ“‚ Property File:<br><input type="file" id="propertyFile"></label><br><br>
    <label>ðŸ“‚ Comps File:<br><input type="file" id="compsFile"></label><br><br>
    <button id="uploadBtn" class="btn">Upload</button>

    <table id="dataTable">
        <thead></thead>
        <tbody></tbody>
    </table>

    <script>
    const progressBar = document.getElementById("progressBar");
    const xhr = new XMLHttpRequest();
    xhr.upload.onprogress = function(e) {
        if (e.lengthComputable) {
            const percent = (e.loaded / e.total) * 100;
            progressBar.value = percent;
        }
    };
    
        let data = [];
        let currentSort = { column: null, ascending: true };

        function formatCurrency(val) {
            if (isNaN(val)) return val;
            return "$" + parseFloat(val).toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function renderTable() {
            const table = document.getElementById('dataTable');
            const thead = table.querySelector('thead');
            const tbody = table.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            if (data.length === 0) return;

            const headers = Object.keys(data[0]);
            const headerRow = document.createElement('tr');
            headers.forEach((header, index) => {
                const th = document.createElement('th');
                th.textContent = header;
                th.classList.add('sortable');
                th.onclick = () => sortTable(index);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);

            data.forEach(row => {
                const tr = document.createElement('tr');
                if (row["High Potential"] === true || row["High Potential"] === "True") {
                    tr.classList.add('highlight');
                }

                headers.forEach(header => {
                    const td = document.createElement('td');
                    if (header === 'Offer Price' || header === 'ARV' || header === 'Listing Price') {
                        td.textContent = formatCurrency(row[header]);
                    } else if (header === 'Loi File') {
                        td.innerHTML = row[header] ? `<a href="/download_loi/${row[header]}" target="_blank">Download</a>` : 'N/A';
                    } else if (header === 'Condition Override') {
                        td.innerHTML = `
                            <select onchange="saveOverride('${row['Id']}', this.value)">
                                <option ${row[header] === 'Light' ? 'selected' : ''}>Light</option>
                                <option ${row[header] === 'Medium' ? 'selected' : ''}>Medium</option>
                                <option ${row[header] === 'Heavy' ? 'selected' : ''}>Heavy</option>
                            </select>
                        `;
                    } else if (header === 'Loi Sent' || header === 'Follow-Up Sent') {
                        const flag = header === 'Loi Sent' ? 'loiSent' : 'followupSent';
                        td.innerHTML = `
                            <input type="checkbox" onchange="updateFlags('${row['Id']}', '${flag}', this.checked)" ${row[header] ? 'checked' : ''}>
                        `;
                    } else {
                        td.textContent = row[header];
                    }
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });
        }

        function sortTable(index) {
            const key = Object.keys(data[0])[index];
            const asc = currentSort.column === key ? !currentSort.ascending : true;
            currentSort = { column: key, ascending: asc };
            data.sort((a, b) => {
                let valA = a[key], valB = b[key];
                if (!isNaN(parseFloat(valA)) && !isNaN(parseFloat(valB))) {
                    valA = parseFloat(valA);
                    valB = parseFloat(valB);
                }
                if (valA < valB) return asc ? -1 : 1;
                if (valA > valB) return asc ? 1 : -1;
                return 0;
            });
            renderTable();
        }

        function saveOverride(id, value) {
            fetch('/save_override', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: id, override: value })
            }).then(() => loadData());
        }

        function updateFlags(id, flag, state) {
            fetch('/update_flags', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: id,
                    loiSent: flag === 'loiSent' ? state : undefined,
                    followupSent: flag === 'followupSent' ? state : undefined
                })
            }).then(() => loadData());
        }

        function loadData() {
            fetch('/data')
                .then(res => res.json())
                .then(json => {
                    data = json;
                    renderTable();
                });
        }

        document.getElementById('uploadBtn').onclick = () => {
            const formData = new FormData();
            const propFile = document.getElementById('propertyFile').files[0];
            const compsFile = document.getElementById('compsFile').files[0];
            const businessName = document.getElementById('businessName').value;
            const userName = document.getElementById('userName').value;
            const userEmail = document.getElementById('userEmail').value;

            if (!propFile || !compsFile) return alert("Please upload both files.");
            formData.append('propertyFile', propFile);
            formData.append('compsFile', compsFile);
            formData.append('businessName', businessName);
            formData.append('userName', userName);
            formData.append('userEmail', userEmail);

            console.log("Upload started...");
            alert("Uploading... Please wait.");
            console.log("Upload started...");
            alert("Uploading... Please wait.");
            fetch('/upload', { method: 'POST', body: formData })
                .then(res => res.text())
                .then(responseText => {
                    try {
                        const json = JSON.parse(responseText);
                        if (json.success) {
                            alert("Upload successful!");
                            loadData();
                        } else {
                            alert("Upload failed. Please check your files.");
                        }
                    } catch (err) {
                        alert("Upload failed. Server response: " + responseText);
                        console.error("Upload response error:", responseText);
                    }
                })
                .catch(err => {
                    alert("Upload failed: " + err.message);
                    console.error("Network or server error:", err);
                });
        };

        loadData();
    </script>
</body>
</html>