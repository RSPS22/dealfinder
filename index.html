<!DOCTYPE html>
<html>
<head>
  <title>Deal Finder</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: left; }
    th { background-color: #f2f2f2; }
    .high { background-color: #c0f0c0; }
  </style>
</head>
<body>
  <h2>Upload Properties and Comps</h2>
  <form id="uploadForm" enctype="multipart/form-data">
    <label>Business Name: <input type="text" name="businessName" required></label><br><br>
    <label>Your Name: <input type="text" name="userName" required></label><br><br>
    <label>Your Email: <input type="email" name="userEmail" required></label><br><br>
    <label>Property File: <input type="file" name="propertyFile" required></label><br><br>
    <label>Comps File: <input type="file" name="compsFile" required></label><br><br>
    <button type="submit">Upload</button>
  </form>

  <h2>Results</h2>
  <table id="dataTable">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script>
    let allData = [];
    const allowedColumns = [
      'Id', 'Address', 'City', 'State', 'Zip',
      'Subdivision', 'Bedrooms', 'Bathrooms',
      'Listing Price', 'Days on Market',
      'Condition Override', 'ARV', 'Offer Price',
      'High Potential', 'LOI File'
    ];

    $(document).ready(function () {
      $('#uploadForm').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        $.ajax({
          url: '/upload',
          method: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function (res) {
            if (res.success) setTimeout(fetchData, 500);
            else alert('Upload failed');
          }
        });
      });

      function fetchData() {
        $.getJSON('/data', function (data) {
          allData = data;
          renderTable();
        });
      }

      function renderTable() {
        const thead = $('#dataTable thead').empty();
        const tbody = $('#dataTable tbody').empty();
        thead.append('<tr>' +
          allowedColumns.map(col => `<th>${col}</th>`).join('') +
          '<th>LOI Sent</th><th>Follow-Up Sent</th><th>Override</th><th>Save</th><th>LOI</th></tr>'
        );

        allData.forEach(row => {
          const tr = $('<tr>').attr('data-id', row['Id']);
          if (row['High Potential']) tr.addClass('high');
          allowedColumns.forEach(col => {
            let val = row[col] || '';
            tr.append(`<td>${val}</td>`);
          });

          tr.append(`<td><input type="checkbox" class="loi-sent" ${row['LOI Sent'] ? 'checked' : ''}></td>`);
          tr.append(`<td><input type="checkbox" class="follow-up-sent" ${row['Follow-Up Sent'] ? 'checked' : ''}></td>`);
          tr.append(`<td>
            <select class="override">
              <option value="Light"${row['Condition Override'] === 'Light' ? ' selected' : ''}>Light</option>
              <option value="Medium"${row['Condition Override'] === 'Medium' ? ' selected' : ''}>Medium</option>
              <option value="Heavy"${row['Condition Override'] === 'Heavy' ? ' selected' : ''}>Heavy</option>
            </select>
          </td>`);
          tr.append('<td><button class="saveBtn">Save</button></td>');
          tr.append(`<td>${row['LOI File'] ? `<a href="/download_loi/${row['LOI File']}" target="_blank">Download</a>` : 'N/A'}</td>`);
          tbody.append(tr);
        });
      }

      $(document).on('click', '.saveBtn', function () {
        const row = $(this).closest('tr');
        const id = row.data('id');
        const override = row.find('.override').val();
        $.ajax({
          url: '/save_override',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ id, override }),
          success: () => fetchData()
        });
      });

      $(document).on('change', '.loi-sent, .follow-up-sent', function () {
        const row = $(this).closest('tr');
        const id = row.data('id');
        const loiSent = row.find('.loi-sent').is(':checked');
        const followupSent = row.find('.follow-up-sent').is(':checked');
        $.ajax({
          url: '/update_flags',
          method: 'POST',
          contentType: 'application/json',
          data: JSON.stringify({ id, loiSent, followupSent }),
          success: () => fetchData()
        });
      });

      fetchData();
    });
  </script>
</body>
</html>