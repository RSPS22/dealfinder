<html>
  <body>
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" name="propertyFile" required>
      <input type="file" name="compsFile" required>
      <button type="submit">Upload</button>
    </form>
    <table id="dataTable"><thead></thead><tbody></tbody></table>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
      const allowedColumns = ['Id', 'Address', 'Condition Override', 'ARV', 'Offer Price', 'High Potential', 'LOI File', 'LOI Sent', 'Follow-Up Sent'];
      $(document).ready(function () {
        $('#uploadForm').on('submit', function (e) {
          e.preventDefault();
          const formData = new FormData(this);
          $.ajax({ url: '/upload', method: 'POST', data: formData, processData: false, contentType: false,
            success: () => fetchData() });
        });
        function fetchData() {
          $.getJSON('/data', function (data) {
            const thead = $('#dataTable thead').empty();
            const tbody = $('#dataTable tbody').empty();
            thead.append('<tr>' + allowedColumns.map(col => '<th>' + col + '</th>').join('') + '</tr>');
            data.forEach(row => {
              const tr = $('<tr>').attr('data-id', row['Id']);
              allowedColumns.forEach(col => {
                let val = row[col];
                if (col === 'LOI Sent' || col === 'Follow-Up Sent') {
                  val = `<input type="checkbox" class="${col.toLowerCase().replace(/ /g, '-')}" ${row[col] ? 'checked' : ''}>`;
                }
                tr.append('<td>' + (val ?? '') + '</td>');
              });
              tbody.append(tr);
            });
          });
        }
        $(document).on('change', '.loi-sent, .follow-up-sent', function () {
          const row = $(this).closest('tr');
          const id = row.data('id');
          const loiSent = row.find('.loi-sent').is(':checked');
          const followupSent = row.find('.follow-up-sent').is(':checked');
          $.ajax({ url: '/update_flags', method: 'POST', contentType: 'application/json',
            data: JSON.stringify({ id, loiSent, followupSent }) });
        });
      });
    </script>
  </body>
</html>